#!/bin/sh

set -e

. /etc/default/openmediavault
. /usr/share/openmediavault/scripts/helper-functions

OMV_NZBGET_USER="nzbget"
OMV_NZBGET_GROUP="users"
ControlUsername=""
ControlPassword=""

case "$1" in
    configure)
        if ! getent passwd nzbget >/dev/null 2>&1; then
            echo "Adding nzbget user..."
            adduser --quiet \
                    --system \
                    --ingroup $OMV_NZBGET_GROUP \
                    --disabled-password \
                    $OMV_NZBGET_USER
            insserv -d nzbget
        else
            echo "nzbget user already exists."
        fi

        if [ ! -f "/usr/share/nzbget/nzbget" ]; then
            echo "Installing latest NZBGet stable version"
            cd /usr/share
            link=`wget -q http://sourceforge.net/projects/nzbget/rss?path=/nzbget-stable -O - | \grep -m1 nzbget-.*-bin-linux.run | sed 's/\(.*\[\)\(.*\)\(]].*\)/\2/'`
            if [ -z $link ]; then
                echo "No stable link found, installing latest NZBGet testing version"
                link=`wget -q http://sourceforge.net/projects/nzbget/rss?path=/nzbget-testing -O - | \grep -m1 nzbget-.*-bin-linux.run | sed 's/\(.*\[\)\(.*\)\(]].*\)/\2/'`
            fi
            #wget http://sourceforge.net/projects/nzbget/files/nzbget-testing/15.0-r1278/nzbget-15.0-testing-r1278-bin-linux.run -O /usr/share/nzbget-bin-linux.run
            echo "Please wait, downloading files....."
            wget http://sourceforge.net/projects/nzbget/files${link} -O /usr/share/nzbget-bin-linux.run > /dev/null 2>&1
            chmod +x /usr/share/nzbget-bin-linux.run
            ./nzbget-bin-linux.run
            rm -Rf /usr/share/nzbget-bin-linux.run
            # Make changes to the default conf file.
            if [ -f "/opt/nzbget/nzbget.conf" ]; then
                mv /opt/nzbget/nzbget.conf /usr/share/nzbget/nzbget.conf.backup
                rm -Rf /opt/nzbget
                ControlUsername=`sed -n '/ControlUsername=/ s///p' /usr/share/nzbget/nzbget.conf.backup | uniq`
                ControlPassword=`sed -n '/ControlPassword=/ s///p' /usr/share/nzbget/nzbget.conf.backup | uniq`
            fi

            if [ -z $ControlUsername ]; then
                ControlUsername=openmediavault
            fi

            if [ -z $ControlPassword ]; then
                ControlPassword=openmediavault
            fi
            # Anything else?
            sed -i 's/ControlUsername.*/ControlUsername='$ControlUsername'/g' /usr/share/nzbget/nzbget.conf
            sed -i 's/ControlPassword.*/ControlPassword='$ControlPassword'/g' /usr/share/nzbget/nzbget.conf
            sed -i 's/DaemonUsername.*/DaemonUsername=nzbget/g' /usr/share/nzbget/nzbget.conf

DaemonUsername=root
        fi

        if ! omv_config_exists "/config/services/nzbget"; then
            echo "Initial configuration."
            object="<enable>0</enable>"
            object="${object}<showtab>0</showtab>"
            omv_config_add_element "/config/services" "nzbget" "${object}" true
        fi

        chown -R nzbget:users /usr/share/nzbget
        chown -R nzbget:users /etc/init.d/nzbget
        chmod -R 775 /usr/share/nzbget

        omv_install_fixperms

        # Activate package triggers. These triggers are only set during the
        # package installation.
        dpkg-trigger update-fixperms
        dpkg-trigger update-locale
    ;;

    abort-upgrade|abort-remove|abort-deconfigure)
    ;;

    *)
        echo "postinst called with unknown argument" >&2
        exit 1
    ;;
esac

exit 0

